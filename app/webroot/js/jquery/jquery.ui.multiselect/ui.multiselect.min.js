(function(a){a.widget("ui.multiselect",{options:{locale:{addAllItems:"add all",removeAllItems:"remove all",saveAll:"save all",cancelAll:"cancel all",selected:"selected",aItem:"A item",nameOfAItem:"name of A item",mark:"mark"},searchable:true,searchViewAll:true,animated:"fast",show:"slideDown",hide:"slideUp",dividerLocation:0.5,nodeComparator:function(c,b){var e=c.text(),d=b.text();return e==d?0:(e<d?-1:1)},target:null,aModel:"model a",bModel:"model b",editAction:"edit",markAction:"mark",aggresiveSearchTrigger:1500},_create:function(){var c=this;this.count=0;this.selectedCount=0;this.searchListCache="";this.aggresiveSearch=false;this.expiredSearchListCache=true;this.dictionaryCache="";this.element.hide();this.elementWidth=this.element.width();this.elementHeight=this.element.height();this.id=this.element.attr("id");this.element.attr("name","data["+this.options.bModel+"]["+this.options.bModel+"][]");this.formContainer=a('<form action="'+this.options.editAction+'.json" method="post" enctype="multipart/form-data" id="widgetBForm"></form>');this.element.wrapAll(this.formContainer);this.itemData=a('<div id="msItemData" class="input"><label for="aItemName">'+this.options.locale.nameOfAItem+'</label><div id="msItemName"><input type="text" id="aItemName" value="" name="data['+this.options.aModel+'][name]"><input type="text" id="aItemSlug" disabled value="" name=""></div><label for="aItemMark">'+this.options.locale.mark+" "+this.options.locale.aItem+'</label><div id="msItemState"><input type="checkbox" id="aItemMark" name=""><span id="aItemMarkTxt"/></div><input type="hidden" id="aItemID" value="" name="data['+this.options.aModel+'][id]"></div>').insertAfter(this.element);this.saveAll=a('<div id="msActions" class="submit"><input id="msCancelAll" type="button" value="'+this.options.locale.cancelAll+'"><input id="msSaveAll" type="submit" value="'+this.options.locale.saveAll+'"></div>').insertAfter(this.itemData);this.container=a('<div class="ui-multiselect ui-helper-clearfix ui-widget"></div>').insertAfter(this.element);this.availableContainer=a('<div class="available"></div>').appendTo(this.container);this.selectedContainer=a('<div class="selected"></div>').appendTo(this.container);this.availableActions=a('<div class="actions ui-widget-header ui-helper-clearfix"><input type="text" class="search empty ui-widget-content ui-corner-all"/><span class="searchIcon ui-icon ui-icon-search"/><a href="#" id="msAddAll">'+this.options.locale.addAllItems+"</a></div>").appendTo(this.availableContainer);this.selectedActions=a('<div class="actions ui-widget-header ui-helper-clearfix"><span id="selectedCount" class="count">0 '+this.options.locale.selected+'</span><div class="loadingSmall"></div><a href="#" id="msRemoveAll">'+this.options.locale.removeAllItems+"</a></div>").appendTo(this.selectedContainer);this.availableList=a('<ul class="available connected-list"><li class="ui-helper-hidden-accessible"></li></ul>').bind("selectstart",function(){return false}).appendTo(this.availableContainer);this.selectedList=a('<ul class="selected connected-list"><li class="ui-helper-hidden-accessible"></li></ul>').bind("selectstart",function(){return false}).appendTo(this.selectedContainer);this.container.width(this.elementWidth);this.availableContainer.width(Math.floor(this.elementWidth*this.options.dividerLocation));this.selectedContainer.css("border-left","1px solid").width(Math.floor(this.elementWidth*(1-this.options.dividerLocation)-1));var b=this.itemData.outerHeight(true);this.availableList.height(Math.max(this.elementHeight-this.availableActions.height()-b,1));this.selectedList.height(Math.max(this.elementHeight-this.selectedActions.height()-b,1));this._populateLists(this.element.children("option"));this.availableList.delegate("li","click",function(d){c._setSelected(a(this),true);c.selectedCount+=1;c._updateCount();return false}).delegate("li","mouseenter",function(){a(this).addClass("ui-state-hover")}).delegate("li","mouseleave",function(){a(this).removeClass("ui-state-hover")});this.selectedList.delegate("li","click",function(d){c._setSelected(a(this),false);c.selectedCount-=1;c._updateCount();return false}).delegate("li","mouseenter",function(){a(this).addClass("ui-state-hover")}).delegate("li","mouseleave",function(){a(this).removeClass("ui-state-hover")});if(!this.options.animated){this.options.show="show";this.options.hide="hide"}if(this.options.searchable){this._registerSearchEvents(this.availableActions.children("input.search:first"));this.availableActions.children(".searchIcon").click(function(){c._filter.apply(c.availableActions.children("input.search:first"),[c.availableList,c.searchListCache])})}else{this.find(".search").hide()}this.selectedActions.children("#msRemoveAll").click(function(){c._populateLists(c.element.children("option").removeAttr("selected"));return false});this.availableActions.children("#msAddAll").click(function(){c._populateLists(c.element.children("option").attr("selected","selected"));return false});a("#widgetBForm").ajaxForm({dataType:"json",success:function(d){if(d.id!=false){c._clearWidgetA();c._setAItem(d.id,d.name,d.slug,d.mark)}}});a("form input").keydown(function(d){if(d.keyCode==13&&d.target.type!="submit"){return false}});a("form input#msCancelAll").unbind().click(function(){c._clearWidgetA()});a("#aItemMark").unbind().click(function(){var d=a(this).is(":checked");if(!d){return false}optionValue=c.itemData.find("#aItemID").val();if(isNaN(optionValue)||optionValue==""){a(this).attr("checked",false);return false}a.ajax({url:c.options.markAction+"/"+optionValue+".json",dataType:"json",success:function(e){c.itemData.find("#aItemMarkTxt").text(e.message).css("visibility","visible");if(e.id!=false){c._markAItem(e.id)}}})})},destroy:function(){this.element.show();this.container.remove();a.Widget.prototype.destroy.call(this)},clearWidgetB:function(){this._unselectSelectedItems()},setAItem:function(e,d,c,b){if(e&&d&&c&&b){b=(parseInt(b))?true:false;this.itemData.find("#aItemID").val(e);this.itemData.find("#aItemName").val(d).attr("title",d);this.itemData.find("#aItemSlug").val(c).attr("title",c);this.itemData.find("#aItemMark").attr("checked",b)}else{this.itemData.find("#aItemID").val("");this.itemData.find("#aItemName").val("").attr("title","");this.itemData.find("#aItemSlug").val("").attr("title","");this.itemData.find("#aItemMark").attr("checked",false)}this.itemData.find("#aItemMarkTxt").css("visibility","hidden")},selectBItems:function(c){for(var b=0;b<c.length;b++){this._selectBItem(c[b])}},_getOptionID:function(c){var b=this.dictionaryCache[c];if(b!=undefined){return b}return null},_getOptionIDFromListElement:function(b){return b.attr("id").replace("option-","")},_getOptionFromID:function(b){return a(this.element[0].options[b])},_getOptionFromListElement:function(b){return this._getOptionFromID(this._getOptionIDFromListElement(b))},_clearWidgetA:function(){this.options.target.multiselectStripped("clearWidgetA")},_markAItem:function(b){this.options.target.multiselectStripped("markAItem",{id:b})},_setAItem:function(e,d,c,b){this.options.target.multiselectStripped("setAItem",{id:e,name:d,slug:c,mark:b})},_selectBItem:function(c){var b=this._getOptionID(c);if(b==null){return}a("li#option-"+b,this.availableList).css("display","block").click()},_updateCount:function(){a("#selectedCount").text(this.selectedCount+" "+this.options.locale.selected)},_unselectSelectedItems:function(){var c=this.selectedList.children("li");var b=c.size();if(b!=0){if(b<=20){c.map(function(){a(this).click()})}else{this.selectedActions.children("#msRemoveAll").click()}}this.expiredSearchListCache=true},_setSelected:function(c,b){var d=this._getOptionIDFromListElement(c);this._getOptionFromID(d).attr("selected",b);if(b){c.children("span").addClass("ui-icon-minusthick").removeClass("ui-icon-plusthick");c.removeClass("ui-state-hover");c.prependTo(this.selectedList)}else{c.children("span").addClass("ui-icon-plusthick").removeClass("ui-icon-minusthick");c.removeClass("ui-state-hover");var e=d;var f=[];while(f.length==0&&e>0){e-=1;f=a("li#option-"+e,this.availableList)}if(f.length==0){this.availableList.prepend(c)}else{f.after(c)}}this.expiredSearchListCache=true;return false},_regenerateSearchListCache:function(){this.searchListCache=this.availableList.children("li").map(function(){return a(this).text().toLowerCase()});this.expiredSearchListCache=false},_registerSearchEvents:function(b){var c=this;this._regenerateSearchListCache();this.aggresiveSearch=(this.count<=this.options.aggresiveSearchTrigger)?true:false;b.unbind("focus").unbind("blur").unbind("keyup.multiselect").unbind("keydown.multiselect");b.bind("focus",function(){a(this).addClass("ui-state-active");if(c.expiredSearchListCache){c._regenerateSearchListCache()}}).bind("blur",function(){a(this).removeClass("ui-state-active")}).bind("keyup.multiselect",function(f){var d=a.ui.keyCode;switch(f.keyCode){case d.ESCAPE:a(this).val("");c._filter.apply(this,[c.availableList,c.searchListCache]);break;default:if(c.aggresiveSearch){c._filter.apply(this,[c.availableList,c.searchListCache])}break}}).bind("keydown.multiselect",function(f){var d=a.ui.keyCode;switch(f.keyCode){case d.TAB:f.preventDefault();case d.ENTER:c._filter.apply(this,[c.availableList,c.searchListCache]);break;case d.ESCAPE:case d.SHIFT:case d.CONTROL:case 18:break;default:break}})},_filter:function(k,l){var m=a(this);var d=a.trim(m.val().toLowerCase());var n=k.children("li");var f=[];if(this.cachedTerm==d){return}this.cachedTerm=d;if(d.length<3){if(n.is(":hidden")){var c=0;var g=0;var h=100;var b=[];do{g=c+h;b.push([c,g]);c+=h}while(g<n.size());b.reverse();var e=null;for(var j=0;j<b.length;j++){window.setTimeout(function(){e=b.pop();currentRows=n.slice(e[0],e[1]);currentRows.css("display","block")},j*50)}}return}if(d){n.css("display","none");l.each(function(o){if(this.indexOf(d)>=0){f.push(o)}});a.each(f,function(){a(n[this]).css("display","block")})}},_populateLists:function(k){var d=this;var e=0;var b=0;var h=null;var f=[];var j="";var g="";for(var c=0;c<k.length;c++){h=k[c].text;f[k[c].value]=c;if(k[c].selected){j+='<li id="option-'+c+'" class="ui-state-default ui-element" title="'+h+'">'+h+'<span class="ui-corner-all ui-icon ui-icon-minusthick"/></li>';b+=1}else{g+='<li id="option-'+c+'" class="ui-state-default ui-element" title="'+h+'">'+h+'<span class="ui-corner-all ui-icon ui-icon-plusthick"/></li>'}e+=1}this.count=e;this.selectedCount=b;this.dictionaryCache=f;this.selectedList.html(j);this.availableList.html(g);this._updateCount()}})})(jQuery);(function(a){a.widget("ui.multiselectStripped",{options:{locale:{addItem:"add",deleteItem:"delete",nameOfAItem:"name of A item"},searchable:true,animated:"fast",show:"slideDown",hide:"slideUp",nodeComparator:function(c,b){var e=c.text(),d=b.text();return e==d?0:(e<d?-1:1)},target:null,loading:"/img/webart/loading.gif" /*(Flag: image-bootstrap-icons)*/,aModel:"model a",addAction:"add",deleteAction:"delete",getBItemsAction:"get_b-items",aggresiveSearchTrigger:1500},_create:function(){var b=this;this.count=0;this.searchListCache="";this.aggresiveSearch=false;this.expiredSearchListCache=true;this.dictionaryCache="";this.element.hide();this.elementWidth=this.element.width();this.elementHeight=this.element.height();this.id=this.element.attr("id");this.container=a('<div class="ui-multiselect ui-helper-clearfix ui-widget"></div>').insertAfter(this.element);this.loadingContainer=a('<div class="loadingBig"><img src="'+this.options.loading+'" width="25" height="25"></div>').appendTo(this.container);this.availableContainer=a('<div class="available"></div>').appendTo(this.container);this.formContainer=a('<form action="'+this.options.addAction+'.json" method="post" enctype="multipart/form-data" id="widgetAForm"><div class="input"><label for="itemName">'+this.options.locale.nameOfAItem+'</label><input type="text" id="itemName" value="" name="data['+this.options.aModel+'][name]"></div><div class="submit"><input type="submit" value="'+this.options.locale.addItem+'"></div></form>').appendTo(this.container);this.upperBar=a('<div class="actions ui-widget-header ui-helper-clearfix"><input type="text" class="search searchStripped empty ui-widget-content ui-corner-all"/><span class="searchIcon ui-icon ui-icon-search"/><div class="loadingSmall"></div></div>').appendTo(this.availableContainer);this.availableList=a('<ul class="available connected-list"><li class="ui-helper-hidden-accessible"></li></ul>').bind("selectstart",function(){return false}).appendTo(this.availableContainer);this.lowerBar=a('<div class="actions ui-widget-header ui-helper-clearfix"><a href="#" id="mssDeleteItem">'+this.options.locale.deleteItem+'</a><a href="#" id="mssAddItem">'+this.options.locale.addItem+"</a></div>").appendTo(this.availableContainer);this.container.width(this.elementWidth);this.availableContainer.width(this.elementWidth);this.availableList.height(Math.max(this.elementHeight-this.upperBar.height()-this.lowerBar.height(),1));this._populateLists(this.element.children("option"));this.availableList.delegate("li","click",function(d){var c=a(this);if(c.hasClass("ui-state-active")){b._setSelected(c,false);b._clearWidgetB()}else{b._setSelected(c,true);b._clearWidgetB();b._editAItem(c)}return false}).delegate("li","mouseenter",function(){a(this).addClass("ui-state-hover")}).delegate("li","mouseleave",function(){a(this).removeClass("ui-state-hover")});this._centerElement(this.loadingContainer,a(window));if(!this.options.animated){this.options.show="show";this.options.hide="hide"}if(this.options.searchable){this._registerSearchEvents(this.upperBar.children("input.search:first"));this.upperBar.children(".searchIcon").click(function(){b._filter.apply(b.upperBar.children("input.search:first"),[b.availableList,b.searchListCache])})}else{this.find(".search").hide()}this.container.ajaxStart(function(){b.showLoadingAnimation(true)}).ajaxStop(function(){b.showLoadingAnimation(false)});a("#widgetAForm").ajaxForm({dataType:"json",success:function(c){if(c.id!=false){a("#widgetAForm").dialog("close");b.element.prepend('<option value="0|'+c.id+"|"+c.slug+'">'+c.name+"</option>");b.availableList.prepend('<li id="option-'+c.id+'" class="ui-state-default ui-element" title="['+c.id+"] "+c.name+'">'+c.name+'<span class="ui-corner-all ui-icon ui-icon-folder-collapsed"/></li>');b._updateCount(+1);b.expiredSearchListCache=true;b._regenerateDictionaryCache()}}});a("#widgetAForm").dialog({modal:true,autoOpen:false,show:"blind",hide:"drop",resizable:false});this.lowerBar.find("#mssAddItem").click(function(c){c.preventDefault();a("#widgetAForm").dialog("open")});a("form input").keydown(function(c){if(c.keyCode==13&&c.target.type!="submit"){return false}});this.availableContainer.find("#mssDeleteItem").click(function(){b.element.find("option:selected").map(function(){var d=a(this);var c=d.val().split("|");var f=c[1];var e=b.availableList.children("li[id=option-"+f+"]");if(isNaN(f)||f==""){return}a.ajax({type:"DELETE",url:b.options.deleteAction+"/"+f+".json",dataType:"json",success:function(g){if(g.id!=false){b._clearWidgetB();d.remove();e.remove();b._updateCount(-1);b.expiredSearchListCache=true;b._regenerateDictionaryCache()}}})})})},destroy:function(){this.element.show();this.container.remove();a.Widget.prototype.destroy.call(this)},showLoadingAnimation:function(c){var b=this.loadingContainer;if(c==true){b.css("visibility","visible")}else{b.css("visibility","hidden")}},clearWidgetA:function(){this._unselectSelectedItems()},markAItem:function(f){if(f.id){var e=this._getOptionID(f.id);var b=this._getOptionFromID(e);var d=this.availableList.children("li#option-"+f.id);var c=this._getAItem(d);if(!c){return}b.val("1|"+f.id+"|"+f.slug);d.addClass("ui-state-error")}},setAItem:function(e){if(e.id&&e.name&&e.slug&&e.mark){var d=this._getOptionID(e.id);var b=this._getOptionFromID(d);var c=this.availableList.children("li#option-"+e.id);(parseInt(e.mark))?c.addClass("ui-state-error"):c.removeClass("ui-state-error");b.val(e.mark+"|"+e.id+"|"+e.slug);b.text(e.name);listElementContent=c.html().replace(c.text(),e.name);c.attr("title","["+e.id+"] "+e.name);c.html(listElementContent);this._regenerateSearchListCache()}},_centerElement:function(b,d){var c=d[0].offsetTop;var e=d[0].offsetLeft;(c==undefined)?c=0:"";(e==undefined)?e=0:"";b.css("position","absolute");b.css("top",c+(d.height()-b.height())/2+d.scrollTop()+"px");b.css("left",e+(d.width()-b.width())/2+d.scrollLeft()+"px")},_getOptionID:function(c){var b=this.dictionaryCache[c];if(b!=undefined){return b}return null},_getOptionIDFromListElement:function(b){return this._getOptionID(b.attr("id").replace("option-",""))},_getOptionFromID:function(b){return a(this.element[0].options[b])},_getOptionFromListElement:function(b){return this._getOptionFromID(this._getOptionIDFromListElement(b))},_clearWidgetB:function(){this.showLoadingAnimation(true);this.options.target.multiselect("setAItem").multiselect("clearWidgetB");this.showLoadingAnimation(false)},_getAItem:function(e){var c=this._getOptionFromListElement(e);var b=c.val().split("|");var d={};d.name=c.text();d.mark=b[0];d.id=b[1];d.slug=b[2];if(d.name!=""&&d.mark!=""&&d.id!=""&&d.slug!=""){return d}return false},_editAItem:function(c){var d=this;var e=this.options.target;var b=this._getAItem(c);if(!b){return}e.multiselect("setAItem",b.id,b.name,b.slug,b.mark);a.ajax({async:true,url:this.options.getBItemsAction+"/"+b.id+".json",dataType:"json",success:function(f){if(f.bItems!=false){e.multiselect("selectBItems",f.bItems.reverse())}}})},_updateCount:function(b){if(isNaN(b)){return false}this.aggresiveSearch=((this.count+=b)<=this.options.aggresiveSearchTrigger)?true:false},_unselectSelectedItems:function(){var c=this.availableList.children("li.ui-state-active");var b=c.size();if(b!=0){if(b<=20){c.map(function(){a(this).click()})}else{this._populateLists(this.element.children("option").removeAttr("selected"))}}},_setSelected:function(c,b){var d=this._getOptionIDFromListElement(c);this._getOptionFromID(d).attr("selected",b);if(b){this._unselectSelectedItems();c.children("span").addClass("ui-icon-folder-open").removeClass("ui-icon-folder-collapsed");c.addClass("ui-state-active ui-priority-primary")}else{c.children("span").addClass("ui-icon-folder-collapsed").removeClass("ui-icon-folder-open");c.removeClass("ui-state-active ui-priority-primary")}},_regenerateSearchListCache:function(){this.searchListCache=this.availableList.children("li").map(function(){return a(this).text().toLowerCase()});this.expiredSearchListCache=false},_regenerateDictionaryCache:function(){var b=this.element.children("option");var e=null;var d=[];for(var c=0;c<b.length;c++){e=b[c].value.split("|")[1];d[e]=c}this.dictionaryCache=d},_registerSearchEvents:function(b){var c=this;this._regenerateSearchListCache();this._updateCount(0);b.unbind("focus").unbind("blur").unbind("keyup.multiselect").unbind("keydown.multiselect");b.bind("focus",function(){a(this).addClass("ui-state-active");if(c.expiredSearchListCache){c._regenerateSearchListCache()}}).bind("blur",function(){a(this).removeClass("ui-state-active")}).bind("keyup.multiselect",function(f){var d=a.ui.keyCode;switch(f.keyCode){case d.ESCAPE:a(this).val("");c._filter.apply(this,[c.availableList,c.searchListCache]);break;default:if(c.aggresiveSearch){c._filter.apply(this,[c.availableList,c.searchListCache])}break}}).bind("keydown.multiselect",function(f){var d=a.ui.keyCode;switch(f.keyCode){case d.TAB:f.preventDefault();case d.ENTER:c._filter.apply(this,[c.availableList,c.searchListCache]);break;case d.ESCAPE:case d.SHIFT:case d.CONTROL:case 18:break;default:break}})},_filter:function(k,l){var m=a(this);var d=a.trim(m.val().toLowerCase());var n=k.children("li");var f=[];if(this.cachedTerm==d){return}this.cachedTerm=d;if(d.length<3){if(n.is(":hidden")){var c=0;var g=0;var h=100;var b=[];do{g=c+h;b.push([c,g]);c+=h}while(g<n.size());b.reverse();var e=null;for(var j=0;j<b.length;j++){window.setTimeout(function(){e=b.pop();currentRows=n.slice(e[0],e[1]);currentRows.css("display","block")},j*50)}}return}if(d){n.css("display","none");l.each(function(o){if(this.indexOf(d)>=0){f.push(o)}});a.each(f,function(){a(n[this]).css("display","block")})}},_populateLists:function(l){var d=this;var e=0;var k=null;var h=null;var b=null;var f=null;var g=[];var j="";for(var c=0;c<l.length;c++){k=l[c].text;h=l[c].value.split("|");b=h[0];f=h[1];g[f]=c;b=(parseInt(b))?" ui-state-error":"";if(l[c].selected){j+='<li id="option-'+f+'" class="ui-state-default ui-element ui-state-active ui-priority-primary'+b+'" title="['+f+"] "+k+'">'+k+'<span class="ui-corner-all ui-icon ui-icon-folder-open"/></li>'}else{j+='<li id="option-'+f+'" class="ui-state-default ui-element'+b+'" title="['+f+"] "+k+'">'+k+'<span class="ui-corner-all ui-icon ui-icon-folder-collapsed"/></li>'}e+=1}this.count=e;this.dictionaryCache=g;this.availableList.html(j)}})})(jQuery);
